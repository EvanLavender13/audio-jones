# AudioJones Codebase Review — Working Notes (gpt-5.2)

Date: 2025-12-16

## Phase 1 — Context Discovery

### Project Conventions (CLAUDE.md)

- C++20 with C-style conventions (raylib/miniaudio style).
- Structures: public fields, direct access; in-class defaults for config structs.
- Functions: `Init/Uninit` pairs for resources; PascalCase with module prefix (e.g., `FFTProcessorInit`).
- Types: explicit types, `NULL`, raw pointers, fixed arrays, C-style casts, `const` for unmodified values.
- Formatting: braces on all control flow, even single statements.
- Comments: explain “why”, not “what”; avoid comments on unchanged code.
- Headers: `.h/.cpp` split; C headers only in headers; isolate STL to `.cpp`.
- Naming: PascalCase functions, camelCase locals, UPPER_SNAKE_CASE constants.
- Known deviation: `src/config/preset.cpp` uses STL for JSON serialization.

### Architecture (docs/architecture.md)

- Thread model: miniaudio callback writes to lock-free ring buffer; main thread drains per-frame (~60Hz) for FFT + beat; visuals update at 20Hz; render at 60Hz.
- Module boundaries: `audio/`, `analysis/`, `automation/`, `render/`, `config/`, `ui/`, `main`.

### Entry Points

- `src/main.cpp`: `main()` initializes subsystems, runs the 60fps loop, dispatches analysis and rendering.
- Audio thread entry: `audio_data_callback` in `src/audio/audio.cpp`.

## Phase 2 — Dependency-Order Traversal

(Traversal derived from quoted `#include` dependencies; reviewed leaves → roots.)

## Phase 2 — Per-Module Notes (Discovery)

### audio/

- Purpose: WASAPI loopback capture into `ma_pcm_rb`.
- Interface: `AudioCapture*` opaque type + `Init/Start/Stop/Read/Available/Uninit`.
- Resources: `ma_device` + `ma_pcm_rb` lifetime managed manually (`calloc/free`, `*_uninit`).
- Concurrency: audio callback writes ring buffer; main thread reads.

### analysis/

- `fft`: accumulates mono samples, applies Hann window, runs kiss FFT with 75% overlap; exposes magnitude bins.
- `beat`: spectral flux in kick range with rolling mean/stddev threshold + debounce; maintains intensity + history graph.
- `bands`: RMS energy for bass/mid/treb with envelope smoothing + running averages (normalization).
- `analysis_pipeline`: drains audio, normalizes buffer (AGC), feeds FFT, drives beat/bands using hop-time dt.

### automation/

- `lfo`: phase accumulator with selectable waveform; sample-and-hold uses `rand()` (lint-suppressed, single-thread assumption).

### render/

- `waveform`/`waveform_pipeline`: mixes stereo → mono based on channel mode, normalizes, builds a palindrome buffer for circular mode, and draws (linear or circular).
- `spectrum_bars`: log-spaced band mapping and dB normalization + smoothing; draws circular or linear.
- `post_effect`: accumulation buffer + feedback/blur/chromatic/voronoi/kaleidoscope shader passes; integrates physarum simulation and optional debug overlay.
- `physarum`: OpenGL 4.3 compute shaders for agent update + trail processing, with SSBO + ping-pong trail textures.

### config/

- POD-ish config structs with defaults; `AppConfigs` bundles pointers for UI/presets.
- `preset`: JSON serialization (STL + `nlohmann::json`), file listing, and conversion to/from `AppConfigs`.

### ui/

- Uses raygui with `UILayout` helper; accordion sections; defers dropdown draws to ensure correct z-order.
- `PanelState` coordinates dropdown open/close, disabling controls behind open dropdowns.

## Phase 2 — Observations Log (Facts First)

- OBSERVATION: `src/main.cpp:77` has a single-statement `if (ctx == NULL) return NULL;` without braces.
- OBSERVATION: `src/analysis/fft.cpp:11-22` uses a static `hannInitialized` flag without synchronization (assumes single-threaded init).
- OBSERVATION: `src/analysis/bands.cpp:10` declares `MIN_DENOM` but it is unused.
- OBSERVATION: `src/analysis/bands.cpp:68-70` running-average smoothing uses fixed coefficients and does not incorporate `dt`.
- OBSERVATION: `src/analysis/bands.h` and `src/analysis/beat.cpp` embed bin ranges assuming 48kHz + 2048 FFT (not derived from `AUDIO_SAMPLE_RATE` / `FFT_SIZE`).
- OBSERVATION: `src/render/spectrum_bars.cpp:71-110` dereferences `config` without checking for `NULL` (unlike `SpectrumBarsDraw*` which checks `config == NULL`).
- OBSERVATION: `src/render/post_effect.cpp:30-39` HDR FBO fallback assigns `*tex = LoadRenderTexture(...)` and then sets `tex->depth.id = 0`.
- OBSERVATION: `src/render/post_effect.cpp:47-57` defines `InitRenderTexture(...)` but it is unused.
- OBSERVATION: `src/render/post_effect.cpp:207-211` `PostEffectInit()` frees `pe` on shader-load failure without unloading any already-loaded shaders.
- OBSERVATION: `src/render/post_effect.cpp:223-229` render-texture init failure path unloads only a subset of shaders before `free(pe)`.
- OBSERVATION: `src/render/physarum.cpp:389-409` `PhysarumResize()` calls `PhysarumReset()` even if `CreateTrailMap(...)` fails (textures may be left with `id = 0`).
- OBSERVATION: `src/render/physarum.cpp:461-468` `PhysarumApplyConfig()` unloads the old SSBO before allocating the replacement; on allocation failure it sets `p->agentBuffer = 0` and returns.
- OBSERVATION: `src/render/physarum.cpp:317` `PhysarumUpdate()` binds `p->agentBuffer` without guarding for `0`.
- OBSERVATION: `src/render/waveform_pipeline.cpp:27` advances `globalTick` even when no audio is available (keeps rotation deterministic).
- EXTRACTION: `src/render/post_effect.cpp` init/cleanup paths repeat resource-unload logic; could be centralized into a single cleanup routine.
- EXTRACTION: `src/render/physarum.cpp` SSBO reallocation path could be refactored to keep the previous buffer intact until the new one succeeds.

