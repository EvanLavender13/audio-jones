# AudioJones Codebase Review — Working Notes (gpt-5.2)

Date: 2025-12-14

## Phase 1 — Context Discovery

### Project Conventions (CLAUDE.md)

- C++20 with C-style conventions (raylib/miniaudio style).
- Structures: public fields, direct access; in-class defaults for config structs.
- Functions: `Init/Uninit` pairs for resources; PascalCase with module prefix (e.g., `FFTProcessorInit`).
- Types: explicit types, `NULL`, raw pointers, fixed arrays, C-style casts, `const` for unmodified values.
- Formatting: braces on all control flow, even single statements.
- Comments: explain “why”, not “what”; avoid comments on unchanged code.
- Headers: `.h/.cpp` split; C headers only in headers; isolate STL to `.cpp`.
- Naming: PascalCase functions, camelCase locals, UPPER_SNAKE_CASE constants.
- Known deviation: `src/config/preset.cpp` uses STL for JSON serialization.

### Architecture (docs/architecture.md)

- Thread model: miniaudio audio callback writes to lock-free ring buffer; main thread drains per-frame (~60Hz) for FFT + beat; visuals update at 20Hz; render at 60Hz.
- Module boundaries: `audio/`, `analysis/`, `automation/`, `render/`, `config/`, `ui/`, `main`.

### Entry Points

- `src/main.cpp`: `main()` is the application entry point and orchestrates initialization, per-frame update, and render.
- Audio thread entry: miniaudio callback inside `src/audio/audio.cpp` (to verify during review).

## Phase 2 — Dependency-Order Traversal

Topological “levels” (0 = no internal `#include` dependencies):

- Level 0: `analysis/bands.h`, `analysis/fft.h`, `audio/audio.h`, `audio/audio_config.h`, `config/band_config.h`, `config/lfo_config.h`, `render/color_config.h`, `render/render_context.h`, `ui/ui_common.h`, `ui/ui_layout.h`
- Level 1: `analysis/bands.cpp`, `analysis/beat.h`, `analysis/fft.cpp`, `audio/audio.cpp`, `automation/lfo.h`, `config/spectrum_bars_config.h`, `config/waveform_config.h`, `render/physarum.h`, `ui/ui_common.cpp`, `ui/ui_color.h`, `ui/ui_layout.cpp`, `ui/ui_panel_audio.h`, `ui/ui_widgets.h`
- Level 2: `analysis/beat.cpp`, `analysis/analysis_pipeline.h`, `automation/lfo.cpp`, `config/effect_config.h`, `render/physarum.cpp`, `render/spectrum_bars.h`, `render/waveform.h`, `ui/ui_panel_analysis.h`, `ui/ui_panel_audio.cpp`, `ui/ui_panel_spectrum.h`, `ui/ui_color.cpp`, `ui/ui_widgets.cpp`
- Level 3: `analysis/analysis_pipeline.cpp`, `config/app_configs.h`, `render/post_effect.h`, `render/spectrum_bars.cpp`, `config/preset.h`, `render/waveform.cpp`, `render/waveform_pipeline.h`, `ui/ui_panel_effects.h`, `ui/ui_panel_waveform.h`, `ui/ui_panel_analysis.cpp`, `ui/ui_panel_spectrum.cpp`
- Level 4: `render/post_effect.cpp`, `config/preset.cpp`, `render/waveform_pipeline.cpp`, `ui/ui_main.h`, `ui/ui_panel_preset.h`, `ui/ui_panel_effects.cpp`, `ui/ui_panel_waveform.cpp`
- Level 5: `main.cpp`, `ui/ui_panel_preset.cpp`, `ui/ui_main.cpp`

## Phase 2 — Observations Log (Facts First)

(Append observations while reviewing; evaluation reserved for Phase 3.)

- OBSERVATION: `src/main.cpp:77` uses `if (ctx == NULL) return NULL;` (single-statement `if` without braces).
- OBSERVATION: `src/analysis/bands.cpp:10` declares `MIN_DENOM` but it is unused.
- OBSERVATION: `src/analysis/bands.cpp:5-7` and `src/analysis/bands.cpp:67-70` running-average smoothing uses fixed coefficients (comment assumes 60Hz) and does not use `dt`.
- OBSERVATION: `src/analysis/bands.h` band bin ranges are defined with constants tied to 48kHz + 2048 FFT assumptions (not derived from `AUDIO_SAMPLE_RATE`/`FFT_SIZE`).
- OBSERVATION: `src/analysis/beat.cpp` kick bin range constants are tied to 48kHz + 2048 FFT assumptions.
- OBSERVATION: `src/render/spectrum_bars.cpp:1-16` uses `#define SAMPLE_RATE 48000.0f` for band mapping (separate from `AUDIO_SAMPLE_RATE`).
- OBSERVATION: `src/render/spectrum_bars.cpp:71-110` dereferences `config` without checking for `NULL` (unlike `SpectrumBarsDraw*` which checks `config == NULL`).
- OBSERVATION: `src/render/waveform.cpp:120-123` has a `CHANNEL_INTERLEAVED` case inside `MixStereoToMono`, but that function is only called from the `mode != CHANNEL_INTERLEAVED` branch in `ProcessWaveformBase`.
- OBSERVATION: `src/render/physarum.cpp:264-273` on SSBO realloc failure, `PhysarumApplyConfig` sets `p->agentBuffer = 0` and returns.
- OBSERVATION: `src/render/physarum.cpp:183` `PhysarumUpdate` unconditionally binds `p->agentBuffer` (no guard for `0`), and `PhysarumApplyConfig` does not attempt recovery when the buffer is `0`.
- OBSERVATION: `src/render/post_effect.cpp:30-41` `InitRenderTextureHDR()` falls back to `LoadRenderTexture()` when HDR FBO is incomplete.
- OBSERVATION: `src/render/post_effect.cpp:39` `InitRenderTextureHDR()` sets `tex->depth.id = 0` even after the fallback assignment.
- OBSERVATION: `src/render/post_effect.cpp:157-163` `PostEffectInit()` frees `pe` on shader-load failure without unloading any already-loaded shaders.
- OBSERVATION: `src/render/post_effect.cpp:198-205` `PostEffectInit()` failure path unloads only a subset of shaders (`blurH`, `blurV`, `chromatic`) before freeing `pe`.
